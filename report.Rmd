---
title: n-rate timing analysis report
author: jesse puka-beals
date: "`r Sys.Date()`"
output:
  pdf_document
editor_options: 
  chunk_output_type: console
---

```{r import, echo=F, message=F}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      include = F, warning = F)

# echo = display code
# message = display code message
# include = include chunk outputs in doc output

library(multcomp)
source("nrate_eda_9dec2022.R")
source("new-dataset.R")
read.csv("field_activities.csv") -> dat_activities


theme_set(theme_bw())

```

# Summary

Need to figure out how to format dataset, how to subset dataset to answer testable hypotheses

Goal: combine all data across sites and years into a similar format for analysis

Issues: Sites are confounded by growing year, stand age, soil, row spacing, treatment rates and timing (except control), duration of study (one site was initiated on a second year stand, other 2 sites on first year stand) and types of data collected (lodging data not available for staples and most of V17).

Dominic's solution: Dominic analyzed all sites separately. If similar patterns arise, great.

Jesse's addition: reformatted data frame (dat_new) to standardize data formatting among sites, will still analyze sites seperately like Dominic.

R100 dataset demonstrates that applying nitrogen to a kernza stand after not fertilizing in year 1 can lead to a lot of lodging which decreases yield, but even plants that did not lodge yielded poorly. Could this be due to harvest too late after shattering? 

# Methods

Yield data was collected from 3 sites. All sites have control plots.

V17: treatments initiated in spring of year 1, 3 years of yield data. No summer N, fall (80N), spring (80N) or split (40N spring, 40N fall)

R100: treatments initiated in spring of year 2, 2 years of yield data. Spring and fall N at 60N, summer N varies.

staples: treatments initiated in spring of year 1, 3 years of yield data. Spring and fall N at 60N, summer N varies.

Fall treatments only begin to occur in year 2.

\newpage

```{r, include=T}

dat_activities %>% 
  dplyr::select(
    starts_with("Harvest")
  ) %>% 
  mutate(location = dat_activities$Location,
         .before=Harvest.2018) %>% 
  knitr::kable(
    caption = "harvest dates"
  )

dat_activities %>% 
  dplyr::select(
    starts_with("Fall")
  ) %>% 
  mutate(location = dat_activities$Location,
         .before=Fall.2017) %>% 
  knitr::kable(
    caption = "fall fertilizing dates"
  )

dat_activities %>% 
  dplyr::select(
    starts_with("Spring")
  ) %>% 
  mutate(location = dat_activities$Location,
         .before=Spring.2018) %>% 
  knitr::kable(
    caption = "spring fertilizing dates"
  )

dat_activities %>% 
  dplyr::select(
    starts_with("Summer")
  ) %>% 
  mutate(location = dat_activities$Location,
         .before=Summer.2018) %>% 
  knitr::kable(
    caption = "summer fertilizing dates"
  )

```

\newpage


# Data summary

```{r, include=T}
dat_v17 %>% 
  bind_rows(dat_staples) %>% 
  bind_rows(dat_r100) %>% 
  # colnames()
  # group_by(location,year,stand.age) %>%
  group_by(year, location, stand.age) %>% 
  # glimpse()
  mutate(year = fct_relevel(year, 
                            "2018", 
                            .before = "2019")) %>% 
  summarise(n=n()) %>% 
  knitr::kable(
    caption = "year X location X stand.age"
  )
```

```{r, include=T, echo=F}


dat_v17 %>% 
  bind_rows(dat_r100) %>% 
  bind_rows(dat_staples) %>% 
  group_by(location, stand.age) %>% 
  summarise(n=n()) %>% 
  knitr::kable(
    caption = "location X stand age"
  )

```

\newpage

```{r, include=T, echo=F}

dat_v17 %>% 
  bind_rows(dat_r100) %>% 
  bind_rows(dat_staples) %>% 
  group_by(location, treatment) %>% 
  summarise(n=n()) %>% 
  knitr::kable(
    caption = "location X treatment"
  )

```


| location | stand.ages | n        | treatments                            | n   |
|----------|------------|----------|---------------------------------------|-----|
| Staples  | 1,2,3      | 54,54,54 | n=18, same as r100                    | 9   |
| R100     | 2,3        | 54,54    | n=18; same as staples                 | 6   |
| V17      | 1,2,3      | 16,16,16 | control, 80 fall, 80 split, 80 spring | 12  |
\newpage
# Datasets

```{r, include=T}

# this dataset is still not fully tested for accuracy yet. 

dat_new %>% 
  dplyr::select(-c(cum_n_harvestreset)) %>%
  mutate(`cumulative N prior to harvest` = fall+spring+summer,.before=yield.kgperha) %>% 
  arrange(id) %>% 
  head(10) %>% 
  knitr::kable(
    caption = "first 10 rows of new data frame used for analysis"
  )

```

| balanced datasets | name        | locations    | stand.ages | treatments           | model                                         |
|------------|------------|------------|------------|------------|------------|
| timing            | dat_timing  | Staples, V17 | 1,2,3      | control, spring only | y\~timing X location X stand.age              |
| timing2           | dat_timing2 | Staples, V17 | 2,3        | control, fall only   | y\~timing X location X stand.age              |
| timing3           |             | R100         | 2,3        | control, spring only |                                               |
| nrate             | dat_nrate   | Staples      | 1,2,3      | all                  | y\~updatednrate X location X stand.age        |
| nrate older stand |             | R100         | 2,3        | all                  | y\~cum_n\_harvestreset X location X stand.age |
| cumulative yield  |             | Staples, V17 | 1,2,3      | control,spring only  |                                               |
|                   |             |              |            |                      |                                               |

\newpage

# Assessment
## yield

```{r, include=T, fig.cap="Yield ranges are acceptable. Slight skew to left in R100, likely due to lodging"}
dat_new %>% 
  ggplot(aes(yield.kgperha)) +
  stat_bin(col=1,
           bins=10) +
  facet_wrap(~location) 

dat_new %>% 
  group_by(location,stand.age) %>% 
  summarise(mean = mean(na.omit(yield.kgperha)),
            sd = sd(na.omit(yield.kgperha)),
            n=n()) %>% 
  mutate(mean = round(mean,0),
         sd=round(sd,0)) %>% 
  knitr::kable(
    caption = "estimated yields were similar to expected yields"
  )
```

\newpage

```{r, include=T, fig.cap="Datapoints with lodging scores greater than 5 removed. Notice R100 is no longer skewed"}

dat_new %>% 
  mutate(lodging.num = lodging) %>% 
  mutate(lodging.num = replace_na(lodging.num,1)) %>% 
  mutate(lodging_status = if_else(
    lodging.num > 5, 
    "yes",
    "no / unknown"
  )) %>% 
  filter(lodging_status == "no / unknown") %>% 
  ggplot(aes(yield.kgperha)) +
  stat_bin(col=1,
           bins=10) +
  facet_wrap(~location)

```

\newpage

```{r, include=T, fig.cap="V17 year 2 bucks trend of decreasing yield from year 2 to 3 and is almost 2X expected value. Bajgain et al 2020 reports MN-Clearwater across 5 MN locations that were all fertilized at 45 kg N ha in spring"}

# from Bajgain 2020
# MN clearwater performance estimated from figure 3
# kg per ha
# fertilized over 45 kg ha

tibble(
  location = "Bajgain et al 2020",
  stand.age = c(1,2,3),
  mean = c(800,550,180),
  sd = c(220,250,30),
  n = NA
) %>% 
  mutate(stand.age = as.factor(stand.age))-> dat_expected

dat_new %>% 
  group_by(location,stand.age) %>% 
  summarise(mean = mean(na.omit(yield.kgperha)),
            sd = sd(na.omit(yield.kgperha)),
            n=n()) %>% 
  bind_rows(dat_expected) %>% 
  arrange(stand.age) %>% 
  ggplot(aes(stand.age,
             mean,
             fill=location)) +
  geom_col(
    position=position_dodge(),
    col=1
    ) +
  labs(
    y="mean grain yield (kg ha)",
    caption = "")


```

\newpage

## lodging

```{r}
dat_new %>% 
  # glimpse()
  ggplot(aes(lodging)) +
  stat_bin() +
  facet_wrap(~location)

# lets get counts on lodging
```


# Analysis

```{r, include=T, fig.cap="Cumulative yield response to cumulative N application suggests R100 behaves differently than other sites. R100 shows no N response with and without lodging scores > 5 in dataset. This figure shows dataset where lodging greater than 5 was filtered out. Not fair including R100 in cumulative yield considering it has only 2 yield vs 3 for V17 and Staples, but amazing control yielded almost as much as Staples in 2 vs 3 years"}

dat_new %>% 
  mutate(lodging.num = lodging) %>% 
  mutate(lodging.num = replace_na(lodging.num,1)) %>% 
  mutate(lodging_status = if_else(
    lodging.num > 5, 
    "yes",
    "no / unknown"
  )) %>% 
  filter(lodging_status == "no / unknown") %>% 
  dplyr::select(location,stand.age, id, fall,spring,summer,yield.kgperha,lodging) %>% 
  group_by(location,id) %>% 
  summarise(cumn_total=sum(fall+spring+fall),
            cumyield_total = sum(yield.kgperha
                                 # na.rm = T #V17 101 has missing yield in year2
                                 ),
            n=n())  %>% 
  # distinct(n)
  ggplot(aes(
    cumn_total,
    cumyield_total,
    col=location
  )) +
  stat_summary(geom="line") +
  stat_summary() +
  labs(caption = "")
```

\newpage

```{r, echo=T, include=T, fig.cap="yield response to the combination of fall spring and summer N"}

dat_new  %>%
  mutate(lodging.num = as.numeric(lodging)) %>% 
  mutate(lodging.num = replace_na(lodging.num,1)) %>% 
  mutate(lodging_status = if_else(
    lodging.num > 5, 
    "yes",
    "no / unknown"
  )) %>% 
  ggplot(aes(fall+spring+summer,yield.kgperha,
             group = stand.age,
             col=stand.age,
             shape = lodging_status) )+
  geom_point(alpha=.5) +
  stat_summary(
    geom="line"
  ) +
  facet_wrap(~location) +
  labs(caption = "lodging score greater than 5 was considered lodging")


```

\newpage
