---
title: "N-rate Timing"
date: "`r Sys.Date()`"
# format: pdf
# format: revealjs
# format:
  # docx:
    # reference-doc: word_style.docx
editor: visual
execute: 
  echo: false
  message: false
  warning: false
editor_options: 
  chunk_output_type: console
---

### To do 

Distill brainstorming done in the EDA scripts, report.Rmd and Dominics word doc into a singular first draft. 

# Data

```{r setup}
library(dplyr)
library(tidyverse)

read.csv(
  "data_nrate-all.csv"
) %>% 
  as_tibble() %>% 
  mutate(stand.age = ordered(stand.age)) %>% 
  mutate(
    across(
      c(block,location, id),
      factor
    )
  ) %>% 
  mutate(n.total = fall+spring+summer) -> dat

```


```{r print datasets, include=F}
dat %>% 
  slice(1:6) %>% 
  knitr::kable(
    caption = "first 5 lines of dataset"
  )

read.csv(
  "metadata_nrate-all.csv"
) %>% 
  knitr::kable(
    capation= "metadata"
  )
```


# Methods

```{r, include=F}
read.csv(
  "field_activities.csv"
) %>% 
  knitr::kable(
    caption = "Dates of key field activities"
  )
```

# Lodging

Understanding lodging is not a primary objective of this experiment, this data was only collected as a covariate if there happened to be a lot of lodging. 

```{r}
dat %>% 
  ggplot(aes(lodging)) +
  stat_bin() + 
  facet_wrap(~location)
```

Only R100 and V17 showed lodging, and only R100 had severe lodging to the point where the yield data probably is not very accurate. 

## R100

R100 only had N applied in the second and third year. 

```{r}
dat %>% 
  filter(location == "R100") %>% 
  ggplot(aes(stand.age,lodging)) +
  geom_boxplot()
```

Lodging only occurred in the stands third year of production.

```{r}
dat %>% 
  filter(location == "R100") %>% 
  ggplot(aes(fall+spring+summer,lodging)) +
  geom_point() +
  stat_smooth(
    method = "lm",
    formula = y~log(x+1),
    se=F
  )
```

We observe a general increase in lodging as nitrogen rate increases. We fit a logistic curve since lodging cannot be greater than 10 and we expect as we increase N rate more lodging will get closer to 10. This curve is obviously not perfect.  


```{r}
dat %>% 
  filter(location == "R100" & stand.age =="3") %>% 
  mutate(timing = gsub("[0-9]","",treatment)) %>% 
  ggplot(aes(fall+spring+summer,lodging, col = timing)) +
  geom_point()
```

```{r}
dat %>% 
  filter(location == "R100" & stand.age =="3") %>% 
  mutate(timing = gsub("[0-9]","",treatment)) %>% 
  ggplot(aes(fall+spring+summer,lodging, col = timing)) +
  stat_summary() +
  stat_smooth(
    se=F,
    method = "lm",
    formula = y~log(x+1)+0
  ) +
  labs(
    caption = "fall split line is hidden underneath spring split"
  )
```




```{r}
dat %>% 
  filter(location == "R100" &
           stand.age == "3") %>% 
  pivot_longer(
    cols = c(fall,spring,summer),
    values_to = "n.rate",
    names_to = "n.timing"
  ) %>% 
  # glimpse() #lodging is now repeated 3 times
  ggplot(aes(x=n.rate,lodging,
             group = n.timing,
             col = n.timing)) +
  stat_summary() +
  stat_smooth(
    se=F,
    method = "lm"
  )
```


```{r}
dat %>% 
  filter(location == "R100" &
           stand.age == "3") %>% 
  pivot_longer(
    cols = c(fall,spring,summer),
    values_to = "n.rate",
    names_to = "n.timing"
  ) %>% 
  filter(
    # n.timing=="fall"
    # n.timing == "spring"
    n.timing == "summer"
  ) %>% 
  lm(
    lodging~n.rate,.
  )
```
 






